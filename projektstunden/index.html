<!doctype html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="theme-color" content="#FFE522" />
  <meta name="application-name" content="Projektstundenerfassung" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Projektstunden" />
  <title>Projektstundenerfassung</title>
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" type="image/svg+xml" sizes="192x192" href="./assets/icons/icon-192.svg" />
  <link rel="icon" type="image/svg+xml" sizes="512x512" href="./assets/icons/icon-512.svg" />
  <link rel="apple-touch-icon" href="./assets/icons/icon-192.svg" />
  <link rel="stylesheet" href="./assets/fontawesome/css/all.min.css" />
  <link rel="stylesheet" href="./assets/css/styles.css" />
</head>
<body class="catalyst-app">
  <div class="app-shell catalyst-layout">
    <aside class="catalyst-sidebar" aria-label="Hauptnavigation">
      <div class="catalyst-sidebar-header">
        <div class="catalyst-sidebar-brand">
          <div class="brand-row">
            <span class="app-icon" aria-hidden="true"><img src="./assets/icons/icon-192.svg" alt="" /></span>
            <h1>Projektstundenerfassung</h1>
          </div>
        </div>
      </div>

      <div class="catalyst-sidebar-body">
        <div class="catalyst-theme-toggle">
          <label class="theme-switch" for="themeToggleSwitch" aria-label="Darstellung wechseln">
            <input id="themeToggleSwitch" type="checkbox" />
            <span class="theme-switch-slider" aria-hidden="true">
              <i class="fa-regular fa-sun theme-icon theme-icon-sun" aria-hidden="true"></i>
              <i class="fa-regular fa-moon theme-icon theme-icon-moon" aria-hidden="true"></i>
            </span>
          </label>
          <button id="openNotificationsBtn" type="button" class="icon-btn catalyst-notification-btn" aria-label="Benachrichtigungen √∂ffnen">
            <i class="fa-regular fa-bell" aria-hidden="true"></i>
            <span id="notificationsBadge" class="notification-badge">1</span>
          </button>
        </div>
        <div class="catalyst-sidebar-spacer" aria-hidden="true"></div>
        <div class="catalyst-sidebar-actions">
          <button id="openFavoritesBtn" type="button" class="btn btn-secondary catalyst-nav-btn">
            <span class="catalyst-nav-icon" aria-hidden="true">
              <i class="fa-regular fa-star icon-regular fav-icon-regular" aria-hidden="true"></i>
              <i class="fa-solid fa-star icon-solid fav-icon-solid" aria-hidden="true"></i>
            </span>
            <span>Favoriten</span>
          </button>
          <button id="openBookingHintsBtn" type="button" class="btn btn-secondary catalyst-nav-btn">
            <span class="catalyst-nav-icon" aria-hidden="true">
              <i class="fa-solid fa-circle-info hints-icon-solid" aria-hidden="true"></i>
            </span>
            <span>Buchungshinweise</span>
          </button>
          <button id="openReportBtn" type="button" class="btn btn-secondary catalyst-nav-btn">
            <span class="catalyst-nav-icon" aria-hidden="true">
              <i class="fa-regular fa-file-lines icon-regular report-icon-regular" aria-hidden="true"></i>
              <i class="fa-solid fa-file-lines icon-solid report-icon-solid" aria-hidden="true"></i>
            </span>
            <span>Report</span>
          </button>

          <div id="controllerSidebarActions" class="controller-sidebar-actions hidden" aria-label="Controlling Navigation">
            <button id="controllerShowEntriesBtn" type="button" class="btn btn-secondary catalyst-nav-btn">
              <span class="catalyst-nav-icon" aria-hidden="true"><i class="fa-solid fa-table-list"></i></span>
              <span>Einzelbuchungen</span>
            </button>
            <button id="controllerShowAnalyticsBtn" type="button" class="btn btn-secondary catalyst-nav-btn">
              <span class="catalyst-nav-icon" aria-hidden="true"><i class="fa-solid fa-chart-line"></i></span>
              <span>Auswertungen</span>
            </button>
            <button id="controllerShowRulesBtn" type="button" class="btn btn-secondary catalyst-nav-btn">
              <span class="catalyst-nav-icon" aria-hidden="true"><i class="fa-solid fa-circle-check"></i></span>
              <span>Regelpr√ºfung</span>
            </button>
            <button id="controllerShowExportBtn" type="button" class="btn btn-secondary catalyst-nav-btn">
              <span class="catalyst-nav-icon" aria-hidden="true"><i class="fa-solid fa-file-export"></i></span>
              <span>Export</span>
            </button>
          </div>
        </div>
      </div>

      <div class="catalyst-sidebar-footer">
        <div class="topbar-profile-group catalyst-sidebar-profile">
          <div id="userProfileTrigger" class="user-chip" role="button" tabindex="0" aria-label="Profil und Einstellungen √∂ffnen">
            <div id="userAvatar" class="user-avatar" aria-hidden="true">MM</div>
            <div class="user-meta">
              <strong id="userName">Max Mustermann</strong>
              <div class="user-subline">
                <span>ID: <span id="userId">01337</span></span>
                <span>‚Ä¢</span>
                <span id="userDepartment">Netzplanung</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <main class="layout catalyst-main-layout">
      <section class="card panel-card form-card">
        <div class="section-head">
          <div>
            <p class="muted">Ausgew√§hlter Tag</p>
            <h2 id="selectedDateLabel">-</h2>
          </div>
          <div class="inline-stats">
            <div>
              <span class="muted">Gebuchte Stunden</span>
              <strong id="dayTotalHours">0,0</strong>
            </div>
            <div>
              <span class="muted">Monatssumme</span>
              <strong id="monthTotalHours">0,0</strong>
            </div>
          </div>
        </div>

        <div id="ruleBanner" class="rule-banner hidden" role="status" aria-live="polite"></div>

        <div class="quick-favorites">
          <span class="muted">Schnellfavoriten</span>
          <div id="favoriteQuickList" class="favorite-quick-list"></div>
        </div>

        <form id="logForm" class="log-form" novalidate>
          <div class="form-grid">
            <label>
              <span>Ort</span>
              <select id="locationSelect" required>
                <option value="">Bitte w√§hlen</option>
              </select>
            </label>

            <label>
              <span>Kostentr√§ger</span>
              <select id="costCenterSelect" required disabled>
                <option value="">Bitte zuerst Ort w√§hlen</option>
              </select>
            </label>

            <label>
              <span>Stunden</span>
              <input id="hoursInput" type="text" placeholder="z.B. 3,5" inputmode="decimal" required />
              <div id="hoursQuickChips" class="hours-quick-chips"></div>
            </label>

            <label class="full-width">
              <div class="label-with-tag">
                <span>Kommentar</span>
                <span id="commentRequirementTag" class="tag optional">Optional</span>
              </div>
              <textarea id="commentInput" rows="3" placeholder="T√§tigkeiten beschreiben"></textarea>
              <div id="commentSuggestionBox" class="comment-suggestion-box hidden" aria-live="polite"></div>
            </label>
          </div>

          <div class="form-actions">
            <button id="saveFavoriteBtn" type="button" class="btn btn-secondary">Als Favorit speichern</button>
            <button id="copyPreviousDayBtn" type="button" class="btn btn-secondary">Vortag kopieren</button>
            <button id="submitBtn" type="submit" class="btn btn-primary">Hinzuf√ºgen</button>
            <button id="cancelEditBtn" type="button" class="btn btn-ghost hidden">Bearbeitung abbrechen</button>
          </div>
        </form>
      </section>

      <aside class="card panel-card calendar-card">
        <div class="calendar-head">
          <div class="calendar-nav-group">
            <button id="prevMonthBtn" type="button" class="icon-btn" aria-label="Vorheriger Monat">‚óÄ</button>
            <h3 id="calendarMonthLabel">-</h3>
            <button id="nextMonthBtn" type="button" class="icon-btn" aria-label="N√§chster Monat">‚ñ∂</button>
          </div>
          <button id="goTodayBtn" type="button" class="btn btn-ghost">Heute</button>
        </div>
        <div class="weekdays">
          <span>Mo</span><span>Di</span><span>Mi</span><span>Do</span><span>Fr</span><span>Sa</span><span>So</span>
        </div>
        <div id="calendarGrid" class="calendar-grid"></div>
        <p class="legend">
          <span><i class="dot dot-gray"></i> keine Buchung</span>
          <span><i class="dot dot-green"></i> Buchung vorhanden</span>
          <span><i class="today-outline"></i> heute</span>
          <span>Rechtsklick: freier Tag</span>
        </p>
        <div id="calendarQualityInline" class="calendar-quality-inline"></div>
      </aside>

      <section class="card panel-card daily-log-card">
        <h3>Daily Log</h3>
        <div id="entryList" class="entry-list"></div>
      </section>

      <section class="card panel-card quality-card">
        <h3>Buchungsg√ºte</h3>
        <div class="quality-plan-row">
          <input id="workPlanInput" type="text" placeholder="Arbeitsplan, z.B. 9/9/9/9" />
          <button id="saveWorkPlanBtn" type="button" class="btn btn-secondary">Speichern</button>
        </div>
        <div id="workPlanStatus" class="muted quality-plan-status"></div>
        <div class="quality-main">
          <div class="quality-chart-block">
            <div id="qualityChart" class="quality-chart" role="img" aria-label="Buchungsg√ºte-Diagramm">
              <span id="qualityChartCenter">0%</span>
            </div>
            <small class="muted">Anteil Projektstunden</small>
          </div>
          <div class="quality-chart-block">
            <div id="qualityCompletenessChart" class="quality-chart quality-chart-status" role="img" aria-label="Vollst√§ndigkeitsstatus">
              <span id="qualityCompletenessCenter">0%</span>
            </div>
            <small id="qualityCompletenessLabel" class="muted">Vollst√§ndigkeit</small>
          </div>
          <div class="quality-metrics">
            <div><span class="muted">Soll</span><strong id="qualityTargetHours">0,0 h</strong></div>
            <div><span class="muted">Gebucht</span><strong id="qualityBookedHours">0,0 h</strong></div>
            <div><span class="muted">Abdeckung</span><strong id="qualityCoverage">0%</strong></div>
          </div>
        </div>
      </section>

      <section id="controllerDashboard" class="card panel-card controller-dashboard hidden" aria-live="polite"></section>
    </main>
  </div>

  <div id="calendarDayPopover" class="calendar-day-popover hidden" aria-hidden="true"></div>

  <div id="undoToast" class="undo-toast hidden" role="status" aria-live="polite">
    <span id="undoToastMessage">Eintrag gel√∂scht.</span>
    <button id="undoDeleteBtn" type="button" class="btn btn-ghost">R√ºckg√§ngig</button>
    <button id="dismissUndoBtn" type="button" class="icon-btn" aria-label="Hinweis schlie√üen">‚úï</button>
  </div>

  <div id="favoritesPopover" class="popover hidden" role="dialog" aria-modal="true" aria-labelledby="favoritesTitle">
    <div class="popover-card favorites-card">
      <div class="popover-head">
        <h3 id="favoritesTitle">Favoriten verwalten</h3>
        <button type="button" class="icon-btn" data-close="favoritesPopover">‚úï</button>
      </div>
      <div class="fav-add-row">
        <button id="saveFavoriteFromPopoverBtn" type="button" class="btn btn-primary">Aktuelle Auswahl als Favorit speichern</button>
      </div>
      <div class="favorite-suggestions-section">
        <p class="muted">Vorschl√§ge aus h√§ufigen Buchungen</p>
        <div id="favoriteSuggestionsList" class="favorite-suggestions-list"></div>
      </div>
      <div id="favoritesList" class="popover-list"></div>
      <div id="favoriteColorPicker" class="favorite-color-picker hidden"></div>
    </div>
  </div>

  <div id="duplicateEntryPopover" class="popover hidden" role="dialog" aria-modal="true" aria-labelledby="duplicateEntryTitle">
    <div class="popover-card" style="width:min(520px, calc(100% - 32px));">
      <div class="popover-head">
        <h3 id="duplicateEntryTitle">√Ñhnliche Buchung vorhanden</h3>
        <button id="dismissDuplicateEntryBtn" type="button" class="icon-btn" aria-label="Schlie√üen">‚úï</button>
      </div>
      <p class="muted">F√ºr diesen Tag gibt es bereits eine Buchung mit gleichem Ort und Kostentr√§ger.</p>
      <div id="duplicateEntryPreview" class="duplicate-entry-preview"></div>
      <div class="form-actions">
        <button id="combineDuplicateEntryBtn" type="button" class="btn btn-primary">Mit anderem Eintrag kombinieren</button>
        <button id="discardDuplicateEntryBtn" type="button" class="btn btn-ghost">Verwerfen</button>
      </div>
    </div>
  </div>

  <div id="sqlInjectionPopover" class="popover hidden" role="dialog" aria-modal="true" aria-labelledby="sqlInjectionTitle">
    <div class="popover-card" style="width:min(460px, calc(100% - 32px));">
      <div class="popover-head">
        <h3 id="sqlInjectionTitle">Nice try üëç</h3>
        <button type="button" class="icon-btn" data-close="sqlInjectionPopover" aria-label="Schlie√üen">‚úï</button>
      </div>
      <p class="muted">Die Eingabe enth√§lt ein Muster, das wie ein SQL-Injection-Versuch aussieht.</p>
      <div class="form-actions">
        <button id="dismissSqlInjectionBtn" type="button" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

  <div id="notificationsPopover" class="popover hidden" role="dialog" aria-modal="true" aria-labelledby="notificationsTitle">
    <div class="popover-card" style="width:min(520px, calc(100% - 32px));">
      <div class="popover-head">
        <h3 id="notificationsTitle">Benachrichtigung</h3>
        <button type="button" class="icon-btn" data-close="notificationsPopover" aria-label="Schlie√üen">‚úï</button>
      </div>
      <div class="notification-update-card">
        <h4 id="notificationsUpdateTitle">Update Buchungshinweise ausgerollt</h4>
        <p class="muted">Bitte mache dich mit den aktualisierten Buchungshinweisen vertraut.</p>
        <p class="notification-update-subtitle muted">Kurzzusammenfassung:</p>
        <ul class="notification-update-list muted">
          <li>Hinweise zur Kommentarpflicht wurden pr√§zisiert.</li>
          <li>Beispiele f√ºr zul√§ssige Kostentr√§ger wurden erg√§nzt.</li>
          <li>Formulierungen bei Regelwarnungen wurden verst√§ndlicher gefasst.</li>
        </ul>
        <p class="muted">Ausgerollt am: <strong id="notificationsUpdateDate">-</strong></p>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-primary" data-close="notificationsPopover">Verstanden</button>
      </div>
    </div>
  </div>

  <div id="reportPopover" class="popover hidden" role="dialog" aria-modal="true" aria-labelledby="reportTitle">
    <div class="popover-card">
      <div class="popover-head">
        <h3 id="reportTitle">Report erstellen</h3>
        <button type="button" class="icon-btn" data-close="reportPopover">‚úï</button>
      </div>
      <div class="form-grid compact">
        <label>
          <span>Von (Monat)</span>
          <div class="report-month-picker">
            <select id="reportStartMonthSelect" aria-label="Startmonat"></select>
            <select id="reportStartYearSelect" aria-label="Startjahr"></select>
          </div>
        </label>
        <label>
          <span>Bis (Monat)</span>
          <div class="report-month-picker">
            <select id="reportEndMonthSelect" aria-label="Endmonat"></select>
            <select id="reportEndYearSelect" aria-label="Endjahr"></select>
          </div>
        </label>
      </div>
      <div id="reportQualitySummary" class="report-quality-summary"></div>
      <div id="reportPreview" class="report-preview"></div>
      <div class="form-actions">
        <button id="downloadCsvBtn" type="button" class="btn btn-secondary">CSV herunterladen</button>
        <button id="downloadJsonBtn" type="button" class="btn btn-secondary">JSON herunterladen</button>
        <button id="downloadXlsxBtn" type="button" class="btn btn-primary">XLSX herunterladen</button>
      </div>
      <small class="muted">Aggregation: Ort (Ebene 1) ‚Üí Kostentr√§ger (Ebene 2)</small>
    </div>
  </div>

  <div id="bookingHintsPopover" class="popover hidden" role="dialog" aria-modal="true" aria-labelledby="bookingHintsTitle">
    <div class="popover-card booking-hints-card">
      <div class="popover-head">
        <h3 id="bookingHintsTitle">Buchungshinweise</h3>
        <button type="button" class="icon-btn" data-close="bookingHintsPopover">‚úï</button>
      </div>

      <div class="booking-hints-content">
        <section class="booking-hints-section">
          <h4>Hinweise auf einen Blick</h4>
          <ul>
            <li>Bitte immer zuerst Ort und dann den passenden Kostentr√§ger ausw√§hlen.</li>
            <li>Achte auf Regelhinweise im Formular, bevor du die Buchung speicherst.</li>
            <li>Stunden nach M√∂glichkeit tagesaktuell und mit kurzen, klaren Kommentaren erfassen.</li>
            <li>Bei Ausnahmen die fachliche Begr√ºndung direkt im Kommentar dokumentieren.</li>
          </ul>
        </section>

        <section class="booking-hints-section">
          <h4>Entscheidungsbaum (Mermaid)</h4>
            <div id="bookingHintsMermaid" class="booking-hints-mermaid" aria-label="Mermaid Entscheidungsbaum">Diagramm wird geladen ‚Ä¶</div>
        </section>

        <section class="booking-hints-section">
          <h4>Szenario-Tabelle</h4>
          <table class="booking-hints-table" aria-label="Beispielhafte Entscheidungsszenarien">
            <thead>
              <tr>
                <th>Szenario</th>
                <th>Pr√ºfung</th>
                <th>Aktion</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Regelwarnung aktiv</td>
                <td>Hinweistext lesen</td>
                <td>Kommentar erg√§nzen und buchen</td>
              </tr>
              <tr>
                <td>Blockierende Regel</td>
                <td>Ort/Kostentr√§ger pr√ºfen</td>
                <td>Auf zul√§ssigen Kostentr√§ger wechseln</td>
              </tr>
              <tr>
                <td>Unklare Zuordnung</td>
                <td>R√ºckfrage dokumentieren</td>
                <td>Transparenter Kommentar eintragen</td>
              </tr>
            </tbody>
          </table>
        </section>

        <section class="booking-hints-section">
          <h4>Aktive Regeln</h4>
          <p id="bookingHintsRuleMeta" class="muted">Aktive Regeln aus rules.json: 0</p>
          <table class="booking-hints-table booking-rules-table" aria-label="Aktive Regeln aus rules.json">
            <thead>
              <tr>
                <th>#</th>
                <th>Severity</th>
                <th>Trigger</th>
                <th>Nachricht</th>
              </tr>
            </thead>
            <tbody id="bookingHintsRulesBody"></tbody>
          </table>
        </section>
      </div>
    </div>
  </div>

  <div id="settingsPopover" class="popover hidden" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="popover-card settings-card">
      <div class="popover-head">
        <h3 id="settingsTitle">Profil & Daten</h3>
        <button type="button" class="icon-btn" data-close="settingsPopover">‚úï</button>
      </div>

      <div class="settings-section">
        <h4>Einstellungen</h4>
        <p class="muted">Favoriten (inkl. Farbe/Icon), Arbeitsplan und freie Tage</p>
        <div class="form-actions">
          <button id="exportSettingsBtn" type="button" class="btn btn-secondary">Einstellungen exportieren</button>
          <button id="importSettingsBtn" type="button" class="btn btn-ghost">Einstellungen importieren</button>
        </div>
        <input id="settingsImportInput" type="file" accept="application/json" class="hidden" />
      </div>

      <div class="settings-section settings-section-debug">
        <div class="settings-debug-head">
          <h4><i class="fa-solid fa-flask" aria-hidden="true"></i> Debug / Mockup</h4>
          <span class="settings-debug-badge">Nicht produktiv</span>
        </div>
        <p class="muted">Nur f√ºr Mockup-Zwecke: Testdaten erzeugen, Local Storage zur√ºcksetzen und Stundenbuchungen importieren/exportieren.</p>
        <div class="settings-debug-actions">
          <button id="seedMockupEntriesBtn" type="button" class="btn btn-secondary">Projektstundenliste zuf√§llig bef√ºllen</button>
          <button id="clearMockupStorageBtn" type="button" class="btn btn-ghost">Local Storage bereinigen</button>
          <button id="exportEntriesDebugBtn" type="button" class="btn btn-secondary">Stunden exportieren</button>
          <button id="importEntriesDebugBtn" type="button" class="btn btn-ghost">Stunden importieren</button>
          <button id="openControllingViewBtn" type="button" class="btn btn-primary settings-debug-controller-btn">
            <i class="fa-solid fa-magnifying-glass-chart" aria-hidden="true"></i>
            <span>Controlling-Ansicht</span>
          </button>
        </div>
        <input id="entriesImportInput" type="file" accept="application/json" class="hidden" />
      </div>
    </div>
  </div>

  <script src="./assets/js/mermaid.min.js"></script>
  <script src="./assets/js/xlsx.full.min.js"></script>
  <script src="./assets/js/app.js" defer></script>
</body>
</html>
